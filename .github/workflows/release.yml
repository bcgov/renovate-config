name: CalVer Release

on:
  schedule:
    # Run on the first day of each quarter (January, April, July, October)
    - cron: "0 10 1 1,4,7,10 *"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 2025.10.1, 2025.10.2)"
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"

      - name: Calculate CalVer version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual release - use input version
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual release version: $VERSION"
          else
            # Scheduled release - calculate quarterly version
            YEAR=$(date +%Y)
            QUARTER=$(printf "%02d" $((($(date +%m) - 1) / 3 * 3 + 1)))
            VERSION="${YEAR}.${QUARTER}"
            echo "Calculated CalVer version: $VERSION"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Verify release and tag are unique
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "$(gh release list --json tagName --jq '.[] | select(.tagName=="'$VERSION'").tagName')" ]; then
            echo "ERROR: Release $VERSION already exists!"
            exit 1
          fi
          echo "Release $VERSION is available"

          if [ -n "$(git tag -l "$VERSION")" ]; then
            echo "ERROR: Tag $VERSION already exists!"
            exit 1
          fi
          echo "Tag $VERSION is available"

      - name: Create CalVer tag
        run: |
          git tag -a "$VERSION" -m "Release $VERSION - Quarterly CalVer release"
          git push origin "$VERSION"
          echo "Created and pushed tag: $VERSION"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "$VERSION" --title "Release $VERSION" --generate-notes

      - name: Verify release
        if: always()
        run: |
          echo "Verifying created release:"
          echo "Tag: $VERSION"
          echo "All tags:"
          git tag -l | sort -V
