name: Release

on:
  workflow_dispatch:
    inputs:
      tag_minor:
        description: 'Minor version tag (e.g., v1.1)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      - name: Configure Git user
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"

      - name: Set version variables
        run: |
          MINOR=${{ github.event.inputs.tag_minor }}
          MAJOR=$(echo $MINOR | cut -d. -f1)
          echo "MAJOR=$MAJOR" >> $GITHUB_ENV
          echo "MINOR=$MINOR" >> $GITHUB_ENV

      - name: Validate version doesn't exist
        run: |
          if gh release view "$MINOR" >/dev/null 2>&1; then
            echo "ERROR: Release $MINOR already exists!"
            exit 1
          fi
          echo "Version $MINOR is available for release"

      - name: Create version tags
        run: |
          # Create all version tags and push simultaneously (prevents Renovate timestamp confusion)
          git tag -f -a "$MAJOR" -m "Release $MAJOR (equivalent to $MINOR)"
          git tag -f -a "$MINOR" -m "Release $MINOR"
          git push origin "$MAJOR" "$MINOR" --force

      - name: Create GitHub release
        run: |
          gh release create "$MINOR" --title "Release $MINOR" --generate-notes

      - name: Verify tags
        run: |
          echo "Verifying created tags:"
          git tag -l | grep -E "^v[0-9]" | sort -V
