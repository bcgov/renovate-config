name: Release

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Full version tag (e.g., v1.1.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set version variables
        run: |
          VERSION=${{ github.event.inputs.version_tag }}
          MAJOR=$(echo $VERSION | cut -d. -f1 | sed 's/^v//')
          MINOR=$(echo $VERSION | cut -d. -f2)
          echo "MAJOR=$MAJOR" >> $GITHUB_ENV
          echo "MINOR=$MINOR" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create version tags
        run: |
          echo "Creating tags for major: v$MAJOR, minor: v$MAJOR.$MINOR"

          # Create all version tags simultaneously for identical timestamps
          # This prevents Renovate from preferring one version over another based on creation time
          git tag -a "v$MAJOR" -m "Release v$MAJOR (equivalent to $VERSION)"
          git tag -a "v$MAJOR.$MINOR" -m "Release v$MAJOR.$MINOR (equivalent to $VERSION)"

          # Push all tags simultaneously
          git push origin "v$MAJOR" "v$MAJOR.$MINOR"

          echo "Successfully created and pushed tags: v$MAJOR, v$MAJOR.$MINOR"

      - name: Create GitHub release with autogenerated notes
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.MAJOR }}.${{ env.MINOR }}
          release_name: Release v${{ env.MAJOR }}.${{ env.MINOR }}
          generate_release_notes: true

      - name: Verify tags
        run: |
          echo "Verifying created tags:"
          git tag -l | grep -E "^v[0-9]" | sort -V
