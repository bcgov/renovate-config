name: CalVer Release

on:
  schedule:
    # Run on the first day of each quarter (January, April, July, October)
    - cron: '0 10 1 1,4,7,10 *'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"

      - name: Calculate CalVer version
        run: |
          # Get current year and month
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          
          # Calculate quarter using mod function
          QUARTER=$(printf "%02d" $(((MONTH - 1) / 3 * 3 + 1)))
          
          VERSION="${YEAR}.${QUARTER}"
          echo "Calculated CalVer version: $VERSION"
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Validate version doesn't already exist
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "ERROR: Release $VERSION already exists!"
            exit 1
          fi
          echo "Version $VERSION is available for release"

      - name: Create CalVer tag
        run: |
          git tag -f -a "$VERSION" -m "Release $VERSION - Quarterly CalVer release"
          git push origin "$VERSION" --force
          echo "Created and pushed tag: $VERSION"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --generate-notes

      - name: Verify release
        run: |
          echo "Verifying created release:"
          echo "Tag: $VERSION"
          echo "All CalVer tags:"
          git tag -l | grep -E "^[0-9]{4}(\.[0-9]{2}(\.[0-9]+)?)?$" | sort -V
